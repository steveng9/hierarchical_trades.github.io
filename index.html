
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Population Genetics Simulator</title>
    <link rel="stylesheet" type="text/css" href="./style.css"></link>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.1/socket.io.js"></script>
    <script type="text/javascript" src="./assetmanager.js"></script>
    <script type="text/javascript" src="./histogram.js"></script>
    <script type="text/javascript" src="./graph.js"></script>
    <script type="text/javascript" src="./variablehistogramviewer.js"></script>
    <script type="text/javascript" src="./variableviewer.js"></script>
    <script type="text/javascript" src="./humandataview.js"></script>
    <script type="text/javascript" src="./gameengine.js"></script>
    <script type="text/javascript" src="./util.js"></script>
    <script type="text/javascript" src="./params.js"></script>
    <script type="text/javascript" src="./gene.js"></script>
    <script type="text/javascript" src="./automata.js"></script>
    <script type="text/javascript" src="./human.js"></script>
    <script type="text/javascript" src="./trade.js"></script>
    <script type="text/javascript" src="./trademanager.js"></script>
    <script type="text/javascript" src="./forest.js"></script>
    <script type="text/javascript" src="./datamanager.js"></script>
    <script type="text/javascript" src="./selectionmanager.js"></script>
    <script type="text/javascript" src="./selectionview.js"></script>
    <script type="text/javascript" src="./tradeview.js"></script>
    <script type="text/javascript" src="./main.js"></script>
</head>
<body>
    <canvas id="gameWorld" width="1260" height="1900"></canvas>
    <div id="controlPanel">
        <div id="db" class="db-status">Database</div>

        <p>Simulation Parameters</p>
        <div id="parameters">

            <!-- LEFT COLUMN -->
            <div class="column">
                <div class="parameter-section">
                    <h3>Sim</h3>
                    <div class="param-row">
                        <span class="param-label">Speed (upd/draw)</span>
                        <input type="range" id="updatesPerDraw" min="10" max="500" step="10"
                               oninput="document.getElementById('updatesPerDraw_val').textContent=this.value">
                        <span class="param-val" id="updatesPerDraw_val"></span>
                    </div>
                </div>

                <div class="parameter-section">
                    <h3>Forest</h3>
                    <div class="param-row">
                        <span class="param-label">Num resources</span>
                        <input type="range" id="numResources" min="2" max="5" step="1"
                               oninput="document.getElementById('numResources_val').textContent=this.value">
                        <span class="param-val" id="numResources_val"></span>
                    </div>
                    <div class="param-row">
                        <span class="param-label">Roughness</span>
                        <input type="range" id="roughness" min="0" max="3" step="0.1"
                               oninput="document.getElementById('roughness_val').textContent=parseFloat(this.value).toFixed(1)">
                        <span class="param-val" id="roughness_val"></span>
                    </div>
                    <div class="param-row">
                        <span class="param-label">Undulation cutoff</span>
                        <input type="range" id="undulation_cutuff" min="0" max="0.9" step="0.05"
                               oninput="document.getElementById('undulation_cutuff_val').textContent=parseFloat(this.value).toFixed(2)">
                        <span class="param-val" id="undulation_cutuff_val"></span>
                    </div>
                    <div class="param-row">
                        <span class="param-label">Initial humans</span>
                        <input type="range" id="initialHumans" min="20" max="500" step="10"
                               oninput="document.getElementById('initialHumans_val').textContent=this.value">
                        <span class="param-val" id="initialHumans_val"></span>
                    </div>
                </div>

                <div class="parameter-section">
                    <h3>Humans</h3>
                    <div class="param-row">
                        <span class="param-label">Energy depletion</span>
                        <input type="range" id="basicEnergyDepletion" min="0.001" max="0.05" step="0.001"
                               oninput="document.getElementById('basicEnergyDepletion_val').textContent=parseFloat(this.value).toFixed(3)">
                        <span class="param-val" id="basicEnergyDepletion_val"></span>
                    </div>
                    <div class="param-row">
                        <span class="param-label">Labor threshold</span>
                        <input type="range" id="production_labor_threshold" min="0" max="1" step="0.05"
                               oninput="document.getElementById('production_labor_threshold_val').textContent=parseFloat(this.value).toFixed(2)">
                        <span class="param-val" id="production_labor_threshold_val"></span>
                    </div>
                    <div class="param-row">
                        <span class="param-label">Labor / cycle</span>
                        <input type="range" id="laborPerCycle" min="0.1" max="5" step="0.1"
                               oninput="document.getElementById('laborPerCycle_val').textContent=parseFloat(this.value).toFixed(1)">
                        <span class="param-val" id="laborPerCycle_val"></span>
                    </div>
                    <div class="param-row">
                        <span class="param-label">Work energy cost</span>
                        <input type="range" id="workEnergyCost" min="0.1" max="5" step="0.1"
                               oninput="document.getElementById('workEnergyCost_val').textContent=parseFloat(this.value).toFixed(1)">
                        <span class="param-val" id="workEnergyCost_val"></span>
                    </div>
                    <div class="param-row">
                        <span class="param-label">Repro. threshold</span>
                        <input type="range" id="reproductionEnergyThreshold" min="80" max="100" step="1"
                               oninput="document.getElementById('reproductionEnergyThreshold_val').textContent=this.value">
                        <span class="param-val" id="reproductionEnergyThreshold_val"></span>
                    </div>
                    <div class="param-row">
                        <span class="param-label">Mutation rate</span>
                        <input type="range" id="reproductionMutationRate" min="0" max="0.5" step="0.01"
                               oninput="document.getElementById('reproductionMutationRate_val').textContent=parseFloat(this.value).toFixed(2)">
                        <span class="param-val" id="reproductionMutationRate_val"></span>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div class="column">
                <div class="parameter-section">
                    <h3>Trading</h3>
                    <div class="check-row">
                        <input type="checkbox" id="fixTradeSurplusRatio">
                        <span>Fix surplus ratio</span>
                    </div>
                    <div class="param-row">
                        <span class="param-label">Labor / resource unit</span>
                        <input type="range" id="laborPerResourceUnit" min="0.01" max="1" step="0.01"
                               oninput="document.getElementById('laborPerResourceUnit_val').textContent=parseFloat(this.value).toFixed(2)">
                        <span class="param-val" id="laborPerResourceUnit_val"></span>
                    </div>
                    <div class="param-row">
                        <span class="param-label">Surplus multiplier</span>
                        <input type="range" id="surplus_multiplier" min="0.01" max="0.5" step="0.01"
                               oninput="document.getElementById('surplus_multiplier_val').textContent=parseFloat(this.value).toFixed(2)">
                        <span class="param-val" id="surplus_multiplier_val"></span>
                    </div>
                    <div class="param-row">
                        <span class="param-label">Build labor / reach</span>
                        <input type="range" id="build_labor_per_reach" min="0" max="2" step="0.05"
                               oninput="document.getElementById('build_labor_per_reach_val').textContent=parseFloat(this.value).toFixed(2)">
                        <span class="param-val" id="build_labor_per_reach_val"></span>
                    </div>
                    <div class="param-row">
                        <span class="param-label">Exp. volume mult.</span>
                        <input type="range" id="expected_volume_multiplier" min="0.5" max="10" step="0.5"
                               oninput="document.getElementById('expected_volume_multiplier_val').textContent=parseFloat(this.value).toFixed(1)">
                        <span class="param-val" id="expected_volume_multiplier_val"></span>
                    </div>
                    <div class="param-row">
                        <span class="param-label">Clear trades every</span>
                        <input type="range" id="clear_trades_every" min="10" max="500" step="10"
                               oninput="document.getElementById('clear_trades_every_val').textContent=this.value">
                        <span class="param-val" id="clear_trades_every_val"></span>
                    </div>
                    <div class="param-row">
                        <span class="param-label">Royalty</span>
                        <input type="range" id="royalty" min="0" max="5" step="0.5"
                               oninput="document.getElementById('royalty_val').textContent=parseFloat(this.value).toFixed(1)">
                        <span class="param-val" id="royalty_val"></span>
                    </div>
                </div>

                <div class="parameter-section">
                    <h3>Hierarchical Trades</h3>
                    <div class="param-row">
                        <span class="param-label">Min supply for hier.</span>
                        <input type="range" id="minTradeSupplyForHierarchy" min="0" max="50" step="1"
                               oninput="document.getElementById('minTradeSupplyForHierarchy_val').textContent=this.value">
                        <span class="param-val" id="minTradeSupplyForHierarchy_val"></span>
                    </div>
                    <div class="param-row">
                        <span class="param-label">Hier. cost mult.</span>
                        <input type="range" id="hierarchicalTradeCostMultiplier" min="0.1" max="5" step="0.1"
                               oninput="document.getElementById('hierarchicalTradeCostMultiplier_val').textContent=parseFloat(this.value).toFixed(1)">
                        <span class="param-val" id="hierarchicalTradeCostMultiplier_val"></span>
                    </div>
                    <div class="param-row">
                        <span class="param-label">Inventor royalty</span>
                        <input type="range" id="inventorPerpetualRoyalty" min="0" max="1" step="0.05"
                               oninput="document.getElementById('inventorPerpetualRoyalty_val').textContent=parseFloat(this.value).toFixed(2)">
                        <span class="param-val" id="inventorPerpetualRoyalty_val"></span>
                    </div>
                    <div class="param-row">
                        <span class="param-label">Min rate improvement</span>
                        <input type="range" id="min_rate_improvement" min="0" max="1" step="0.05"
                               oninput="document.getElementById('min_rate_improvement_val').textContent=parseFloat(this.value).toFixed(2)">
                        <span class="param-val" id="min_rate_improvement_val"></span>
                    </div>
                </div>
            </div>

        </div>

        <!-- Saved configurations -->
        <details id="saved-configs-panel" open>
            <summary>Saved Configurations</summary>
            <div id="save-config-row">
                <input type="text" id="config_name" placeholder="Config name…" />
                <button class="btn-small" onclick="saveConfig()">Save</button>
                <button class="btn-small btn-export" onclick="exportConfigs()">Export JSON</button>
                <label class="btn-small btn-export" style="cursor:pointer;display:inline-block;">
                    Import JSON<input type="file" id="import_file" accept=".json" style="display:none" onchange="importConfigs(this)">
                </label>
            </div>
            <div id="saved_configs_list"></div>
        </details>

        <button type="button" onclick="reset()">Reset Simulation</button>
        <button type="button" onclick="pause()">Pause / Play (Space)</button>
        <button type="button" onclick="toggleSocialReach()">Toggle Social Reach</button>
        <button type="button" onclick="clearHumanSelection()">Clear Selection</button>

        <div style="display:flex;align-items:center;gap:5px;margin-top:8px;">
            <span style="font-size:12px;">Find human:</span>
            <input type="number" id="human_lookup" placeholder="ID" min="0"
                   style="width:60px;padding:2px 4px;font-size:12px;"
                   onkeydown="if(event.key==='Enter') lookupHuman()">
            <button class="btn-small" onclick="lookupHuman()">Go</button>
            <span id="human_lookup_status" style="font-size:11px;color:#888;"></span>
        </div>
        <div style="display:flex;align-items:center;gap:5px;margin-top:6px;">
            <span style="font-size:12px;">Find trade:</span>
            <input type="number" id="trade_lookup" placeholder="ID" min="0"
                   style="width:60px;padding:2px 4px;font-size:12px;"
                   onkeydown="if(event.key==='Enter') lookupTrade()">
            <button class="btn-small" onclick="lookupTrade()">Go</button>
            <span id="trade_lookup_status" style="font-size:11px;color:#888;"></span>
        </div>
    </div>

    <script>
        const SAVED_CONFIGS_KEY = 'hierarchicalTrades_savedConfigs';

        function initParamInputs() {
            Object.keys(PARAMS).forEach(key => {
                const input = document.getElementById(key);
                if (!input) return;
                if (input.type === 'checkbox') {
                    input.checked = PARAMS[key];
                } else {
                    input.value = PARAMS[key];
                    // Set the value display span directly from PARAMS (avoids slider snap discrepancy)
                    const valSpan = document.getElementById(key + '_val');
                    if (valSpan) {
                        const v = PARAMS[key];
                        valSpan.textContent = Number.isInteger(v) ? v : parseFloat(v).toFixed(3).replace(/\.?0+$/, '');
                    }
                }
            });
        }

        function saveConfig() {
            const nameInput = document.getElementById('config_name');
            const name = nameInput.value.trim();
            if (!name) { alert('Please enter a name for this config.'); return; }
            loadParameters();
            const config = {
                name,
                timestamp: new Date().toISOString(),
                params: Object.assign({}, PARAMS)
            };
            const configs = getSavedConfigs();
            const idx = configs.findIndex(c => c.name === name);
            if (idx >= 0) {
                if (!confirm(`Replace existing config "${name}"?`)) return;
                configs[idx] = config;
            } else {
                configs.push(config);
            }
            localStorage.setItem(SAVED_CONFIGS_KEY, JSON.stringify(configs));
            renderSavedConfigs();
            nameInput.value = '';
        }

        function getSavedConfigs() {
            try { return JSON.parse(localStorage.getItem(SAVED_CONFIGS_KEY)) || []; }
            catch(e) { return []; }
        }

        function loadConfigByIndex(i) {
            const config = getSavedConfigs()[i];
            if (!config) return;
            // Apply ALL saved params directly to PARAMS — works even if UI has changed
            Object.assign(PARAMS, config.params);
            initParamInputs();
            reset();
        }

        function deleteConfigByIndex(i) {
            if (!confirm('Delete this config?')) return;
            const configs = getSavedConfigs();
            configs.splice(i, 1);
            localStorage.setItem(SAVED_CONFIGS_KEY, JSON.stringify(configs));
            renderSavedConfigs();
        }

        function exportConfigs() {
            const configs = getSavedConfigs();
            if (configs.length === 0) { alert('No saved configs to export.'); return; }
            download('hierarchical_trades_configs.json', JSON.stringify(configs, null, 2));
        }

        function importConfigs(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (!Array.isArray(imported)) throw new Error('Expected an array of configs');
                    const existing = getSavedConfigs();
                    let added = 0, replaced = 0;
                    for (const config of imported) {
                        if (!config.name || !config.params) continue;
                        const idx = existing.findIndex(c => c.name === config.name);
                        if (idx >= 0) { existing[idx] = config; replaced++; }
                        else { existing.push(config); added++; }
                    }
                    localStorage.setItem(SAVED_CONFIGS_KEY, JSON.stringify(existing));
                    renderSavedConfigs();
                    alert(`Imported: ${added} new, ${replaced} replaced.`);
                } catch(err) {
                    alert('Import failed: ' + err.message);
                }
                input.value = ''; // reset so same file can be re-imported
            };
            reader.readAsText(file);
        }

        function lookupTrade() {
            const id = parseInt(document.getElementById('trade_lookup').value);
            const status = document.getElementById('trade_lookup_status');
            if (isNaN(id)) { status.textContent = 'enter an ID'; status.style.color = '#888'; return; }

            const trade = gameEngine.automata.trademanager.trades.find(t => t.id === id);
            if (trade) {
                const tdv = gameEngine.automata.datamanager.tradeDataView;
                tdv.selectedTrade = trade;
                gameEngine.automata.forest.selectTrade(trade);
                status.textContent = `T${id} selected (L${trade.level})`;
                status.style.color = '#080';
            } else {
                status.textContent = `T${id} no longer exists`;
                status.style.color = '#c00';
            }
        }

        function lookupHuman() {
            const id = parseInt(document.getElementById('human_lookup').value);
            const status = document.getElementById('human_lookup_status');
            if (isNaN(id)) { status.textContent = 'enter an ID'; status.style.color = '#888'; return; }

            const hdv = gameEngine.automata.datamanager.humanDataView;
            const human = gameEngine.automata.humanById.get(id);
            if (human) {
                hdv.selectedHumans.add(id);
                hdv.syncSelection();
                status.textContent = `H${id} selected`;
                status.style.color = '#080';
            } else {
                status.textContent = `H${id} no longer exists`;
                status.style.color = '#c00';
            }
        }

        function renderSavedConfigs() {
            const list = document.getElementById('saved_configs_list');
            const configs = getSavedConfigs();
            list.innerHTML = '';
            if (configs.length === 0) {
                list.innerHTML = '<span class="no-configs">No saved configurations</span>';
                return;
            }
            configs.forEach((config, i) => {
                const row = document.createElement('div');
                row.className = 'config-row';
                const date = new Date(config.timestamp).toLocaleString();
                row.innerHTML =
                    `<span class="config-name" title="${date}">${config.name}</span>` +
                    `<button class="btn-small" onclick="loadConfigByIndex(${i})">Load</button>` +
                    `<button class="btn-small btn-danger" onclick="deleteConfigByIndex(${i})">Del</button>`;
                list.appendChild(row);
            });
        }

        window.onload = function () {
            initParamInputs();
            renderSavedConfigs();

            // Spacebar pause/play — document-level so it works regardless of focus,
            // but ignored when typing in any input/textarea
            document.addEventListener('keydown', function(e) {
                if (e.code !== 'Space') return;
                const tag = document.activeElement.tagName;
                if (tag === 'INPUT' || tag === 'TEXTAREA') return;
                e.preventDefault(); // block scroll and accidental button activation
                pause();
            });

            const canvas = document.getElementById("gameWorld");
            canvas.width = PARAMS.canvaswidth;

            canvas.addEventListener("click", (e) => {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                gameEngine.clickCapableGraphs.forEach(graph => {
                    graph.handleClick(mouseX, mouseY);
                });
            });

            let isSpawning = false;
            let isSelecting = false;

            canvas.addEventListener("mousedown", function(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                if (x < canvas.width) {
                    if (e.shiftKey) {
                        isSelecting = true;
                        gameEngine.selection.beginSelection(x, y);
                    } else {
                        isSpawning = true;
                        gameEngine.selection.beginSpawn(x, y);
                    }
                }
            });

            canvas.addEventListener("mousemove", function(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                if (x < canvas.width) {
                    if (isSelecting) gameEngine.selection.updateSelection(x, y);
                    if (isSpawning) gameEngine.selection.updateSpawn(x, y);
                }
            });

            canvas.addEventListener("mouseup", function(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                if (isSelecting) gameEngine.selection.finishSelection(x, y);
                if (isSpawning) gameEngine.selection.finishSpawn(x, y);
                isSelecting = false;
                isSpawning = false;
            });
        };
    </script>
</body>
</html>
